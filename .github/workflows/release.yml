name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (example: v1.2.0)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - run: npm run typecheck

      - run: npm run build:all

      - name: Package extensions
        run: |
          rm -f chatgpt-speed-booster-chrome.zip chatgpt-speed-booster-firefox.zip chatgpt-speed-booster-edge.zip chatgpt-speed-booster-safari.zip
          for browser in chrome firefox edge safari; do
            cd "dist/${browser}"
            zip -r "../../chatgpt-speed-booster-${browser}.zip" .
            cd - >/dev/null
          done

      - name: Validate Firefox data collection manifest field
        run: |
          node -e '
            const fs = require("fs");
            const manifest = JSON.parse(fs.readFileSync("dist/firefox/manifest.json", "utf8"));
            const required = manifest?.browser_specific_settings?.gecko?.data_collection_permissions?.required;
            if (!Array.isArray(required) || !required.includes("none")) {
              console.error("Firefox manifest is missing browser_specific_settings.gecko.data_collection_permissions.required=[\"none\"]");
              process.exit(1);
            }
          '

      - name: Validate zip structure
        run: |
          for browser in chrome firefox edge safari; do
            zip_file="chatgpt-speed-booster-${browser}.zip"
            unzip -Z1 "$zip_file" | grep -qx "manifest.json" || {
              echo "manifest.json missing at zip root in $zip_file"
              exit 1
            }
            unzip -Z1 "$zip_file" | grep -q "^${browser}/" && {
              echo "zip has nested ${browser}/ folder in $zip_file"
              exit 1
            }
          done

      - name: Resolve release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ inputs.tag }}" ]; then
            echo "value=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=v$(node -p 'require("./package.json").version')" >> "$GITHUB_OUTPUT"
          fi

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          name: ${{ steps.tag.outputs.value }}
          overwrite_files: true
          fail_on_unmatched_files: true
          generate_release_notes: true
          files: |
            chatgpt-speed-booster-chrome.zip
            chatgpt-speed-booster-firefox.zip
            chatgpt-speed-booster-edge.zip
            chatgpt-speed-booster-safari.zip
